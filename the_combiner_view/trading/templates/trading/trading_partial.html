<div class="h-full bg-white dark:bg-gray-800 p-4 rounded-lg">
    <h2 class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-100">Trading Dashboard</h2>
    <div id="trading-status" class="flex items-center gap-2 text-sm">
        <span class="status-dot w-2 h-2 rounded-full"></span>
        <span class="status-text"></span>
    </div>
    <div id="token-toasts" class="fixed bottom-4 right-4 space-y-2 z-50"></div>
</div>

<script>
    let tradingSocket = null;
    let mouseMovedTimeout = null;
    let toastTimeouts = new Map();

    // Track mouse movement
    document.addEventListener('mousemove', () => {
        if (mouseMovedTimeout) {
            clearTimeout(mouseMovedTimeout);
        }
        mouseMovedTimeout = setTimeout(() => {
            clearAllToasts();
        }, 5000);
    });

    function clearAllToasts() {
        const toasts = document.querySelectorAll('.token-toast');
        toasts.forEach(toast => {
            fadeOutAndRemoveToast(toast);
        });
    }

    function fadeOutAndRemoveToast(toast) {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
    }

    function createTokenToast(token) {
        const toast = document.createElement('div');
        toast.className = `token-toast p-3 rounded-lg shadow-lg border transition-opacity duration-300 flex items-center justify-between gap-2`;
        
        // Set background and border colors based on exchange
        let exchangeColors;
        switch (token.exchange.toLowerCase()) {
            case 'binance':
                exchangeColors = 'bg-yellow-100 dark:bg-yellow-900 border-yellow-400';
                break;
            case 'bybit':
                exchangeColors = 'bg-purple-100 dark:bg-purple-900 border-purple-400';
                break;
            case 'kucoin':
                exchangeColors = 'bg-emerald-100 dark:bg-emerald-900 border-emerald-400';
                break;
            default:
                exchangeColors = 'bg-gray-100 dark:bg-gray-900 border-gray-400';
        }
        
        toast.className += ` ${exchangeColors}`;

        const content = `
            <div>
                <h3 class="font-medium text-gray-900 dark:text-gray-100">${token.token}</h3>
                <div class="flex gap-1.5 mt-1">
                    <span class="px-1.5 py-0.5 rounded-full text-xs font-medium bg-opacity-50 ${exchangeColors}">
                        ${token.exchange}
                    </span>
                    <span class="px-1.5 py-0.5 rounded-full text-xs font-medium ${
                        token.market === 'spot' 
                            ? 'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-100' 
                            : 'bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-100'
                    }">
                        ${token.market}
                    </span>
                </div>
            </div>
        `;

        toast.innerHTML = content;
        return toast;
    }

    function connectWebSocket() {
        tradingSocket = new WebSocket(
            'ws://' + window.location.host + '/ws/trading/'
        );

        tradingSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            
            if (data.type === 'connection_status') {
                const statusElement = document.getElementById('trading-status');
                const statusDot = statusElement.querySelector('.status-dot');
                const statusText = statusElement.querySelector('.status-text');
                
                statusText.textContent = data.is_external_connected ? 'Connected' : 'Disconnected';
                
                if (data.is_external_connected) {
                    statusDot.className = 'status-dot w-2 h-2 rounded-full bg-green-500 dark:bg-green-400';
                    statusText.className = 'status-text text-green-600 dark:text-green-400';
                } else {
                    statusDot.className = 'status-dot w-2 h-2 rounded-full bg-red-500 dark:bg-red-400';
                    statusText.className = 'status-text text-red-600 dark:text-red-400';
                }
            } else if (data.type === 'tokens') {
                const toastContainer = document.getElementById('token-toasts');
                
                data.data.forEach(token => {
                    const toast = createTokenToast(token);
                    toastContainer.appendChild(toast);
                });
            }
        };

        tradingSocket.onclose = function(e) {
            console.log('Trading WebSocket disconnected. Reconnecting...');
            setTimeout(connectWebSocket, 1000);
        };

        tradingSocket.onerror = function(e) {
            console.error('Trading WebSocket error:', e);
        };
    }

    connectWebSocket();
</script> 