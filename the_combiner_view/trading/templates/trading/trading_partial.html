<div class="h-full bg-white dark:bg-gray-800 p-4 rounded-lg">
    <h2 class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-100">Trading Dashboard</h2>
    
    <div class="mb-4">
        <a href="{% url 'trading:accounts' %}" 
           class="inline-block px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors">
            View Trading Accounts
        </a>
    </div>

    <div id="trading-status" class="flex items-center gap-2 text-sm">
        <span class="status-dot w-2 h-2 rounded-full"></span>
        <span class="status-text"></span>
    </div>
    <div id="token-toasts" class="fixed bottom-4 right-4 space-y-2 z-50"></div>
</div>

<script>
    let tradingSocket = null;
    let mouseMovedTimeout = null;
    let toastTimeouts = new Map();

    // Track mouse movement
    document.addEventListener('mousemove', () => {
        if (mouseMovedTimeout) {
            clearTimeout(mouseMovedTimeout);
        }
        mouseMovedTimeout = setTimeout(() => {
            clearAllToasts();
        }, 5000);
    });

    function clearAllToasts() {
        const toasts = document.querySelectorAll('.token-toast');
        toasts.forEach(toast => {
            fadeOutAndRemoveToast(toast);
        });
    }

    function fadeOutAndRemoveToast(toast) {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
    }

    function createTokenToast(token) {
        const toast = document.createElement('div');
        toast.className = `token-toast p-3 rounded-lg shadow-lg border transition-opacity duration-300`;
        
        // Set background and border colors based on exchange
        let exchangeColors;
        switch (token.exchange.toLowerCase()) {
            case 'binance':
                exchangeColors = 'bg-yellow-100 dark:bg-yellow-900 border-yellow-300 dark:border-yellow-700 text-yellow-800 dark:text-yellow-100';
                break;
            case 'bybit':
                exchangeColors = 'bg-purple-100 dark:bg-purple-900 border-purple-300 dark:border-purple-700 text-purple-800 dark:text-purple-100';
                break;
            case 'kucoin':
                exchangeColors = 'bg-emerald-100 dark:bg-emerald-900 border-emerald-300 dark:border-emerald-700 text-emerald-800 dark:text-emerald-100';
                break;
            default:
                exchangeColors = 'bg-gray-100 dark:bg-gray-900 border-gray-300 dark:border-gray-700 text-gray-800 dark:text-gray-100';
        }
        
        toast.className += ` ${exchangeColors}`;

        const content = `
            <div class="flex justify-between items-center gap-3">
                <div>
                    <h3 class="font-medium">${token.token}</h3>
                    <div class="flex gap-1.5 mt-1">
                        <span class="px-1.5 py-0.5 rounded-full text-xs font-medium ${
                            token.exchange.toLowerCase() === 'binance' ? 'bg-yellow-200 dark:bg-yellow-800 text-yellow-800 dark:text-yellow-100' :
                            token.exchange.toLowerCase() === 'bybit' ? 'bg-purple-200 dark:bg-purple-800 text-purple-800 dark:text-purple-100' :
                            token.exchange.toLowerCase() === 'kucoin' ? 'bg-emerald-200 dark:bg-emerald-800 text-emerald-800 dark:text-emerald-100' :
                            'bg-gray-200 dark:bg-gray-800 text-gray-800 dark:text-gray-100'
                        }">
                            ${token.exchange}
                        </span>
                        <span class="px-1.5 py-0.5 rounded-full text-xs font-medium ${
                            token.market === 'spot' 
                                ? 'bg-green-200 dark:bg-green-800 text-green-800 dark:text-green-100' 
                                : 'bg-blue-200 dark:bg-blue-800 text-blue-800 dark:text-blue-100'
                        }">
                            ${token.market}
                        </span>
                    </div>
                </div>
                <div class="text-right text-xs opacity-75">
                    ${new Date().toLocaleTimeString()}
                </div>
            </div>
        `;

        toast.innerHTML = content;
        return toast;
    }

    async function refreshLatestTokens() {
        try {
            const response = await fetch('/get_latest_tokens/');
            const html = await response.text();
            const latestTokensContainer = document.getElementById('latest-tokens-list');
            if (latestTokensContainer) {
                latestTokensContainer.innerHTML = html;
            } else {
                console.error('Latest tokens container not found');
            }
        } catch (error) {
            console.error('Error refreshing latest tokens:', error);
        }
    }

    function connectWebSocket() {
        tradingSocket = new WebSocket(
            'ws://' + window.location.host + '/ws/trading/'
        );

        tradingSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            
            if (data.type === 'connection_status') {
                const statusElement = document.getElementById('trading-status');
                const statusDot = statusElement.querySelector('.status-dot');
                const statusText = statusElement.querySelector('.status-text');
                
                statusText.textContent = data.is_external_connected ? 'Connected' : 'Disconnected';
                
                if (data.is_external_connected) {
                    statusDot.className = 'status-dot w-2 h-2 rounded-full bg-green-500 dark:bg-green-400';
                    statusText.className = 'status-text text-green-600 dark:text-green-400';
                } else {
                    statusDot.className = 'status-dot w-2 h-2 rounded-full bg-red-500 dark:bg-red-400';
                    statusText.className = 'status-text text-red-600 dark:text-red-400';
                }
            } else if (data.type === 'tokens') {
                const toastContainer = document.getElementById('token-toasts');
                data.data.forEach(token => {
                    const toast = createTokenToast(token);
                    toastContainer.appendChild(toast);
                });
                refreshLatestTokens();
            }
        };

        tradingSocket.onclose = function(e) {
            console.log('Trading WebSocket disconnected. Reconnecting...');
            setTimeout(connectWebSocket, 1000);
        };

        tradingSocket.onerror = function(e) {
            console.error('Trading WebSocket error:', e);
        };
    }

    connectWebSocket();
</script> 